name: Release App

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (skip upload)'
        type: boolean
        default: true
      platform:
        description: 'Target platform'
        type: choice
        options:
          - both
          - ios
          - android
        default: both

permissions:
  contents: write
  id-token: write

jobs:
  version:
    name: Determine Version
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.semantic.outputs.new_release_version }}
      new_release_published: ${{ steps.semantic.outputs.new_release_published }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install semantic-release
        run: npm install --no-save --legacy-peer-deps semantic-release @semantic-release/changelog @semantic-release/git @semantic-release/exec

      - name: Run semantic-release
        id: semantic
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: github-actions[bot]@users.noreply.github.com
          GIT_COMMITTER_NAME: github-actions[bot]
          GIT_COMMITTER_EMAIL: github-actions[bot]@users.noreply.github.com
        run: |
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            npx semantic-release --dry-run 2>&1 | tee sr-output.txt
            VERSION=$(grep -oP 'The next release version is \K[0-9]+\.[0-9]+\.[0-9]+' sr-output.txt || echo "")
            echo "new_release_version=$VERSION" >> "$GITHUB_OUTPUT"
            echo "new_release_published=$( [ -n \"$VERSION\" ] && echo true || echo false )" >> "$GITHUB_OUTPUT"
          else
            npx semantic-release
          fi

      - name: Version summary
        run: |
          echo "## Version" >> "$GITHUB_STEP_SUMMARY"
          echo "- New version: ${{ steps.semantic.outputs.new_release_version }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Published: ${{ steps.semantic.outputs.new_release_published }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Dry run: ${{ inputs.dry_run }}" >> "$GITHUB_STEP_SUMMARY"

  build-ios:
    name: Build iOS
    needs: version
    if: |
      needs.version.outputs.new_release_published == 'true' &&
      (inputs.platform == 'both' || inputs.platform == 'ios')
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Cache node_modules
        id: cache-node-ios
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node-${{ hashFiles('package-lock.json') }}

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: ios/Pods
          key: pods-${{ hashFiles('ios/Podfile.lock') }}
          restore-keys: pods-

      - name: Download mopro binaries
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          gh release download mopro-binaries-v0.3.2 \
            --pattern 'MoproFfiFramework.xcframework.tar.gz' \
            --dir /tmp
          tar xzf /tmp/MoproFfiFramework.xcframework.tar.gz -C mopro_bindings/

      - name: Install dependencies
        if: steps.cache-node-ios.outputs.cache-hit != 'true'
        run: npm install --legacy-peer-deps

      - name: Install CocoaPods
        run: cd ios && pod install --repo-update

      - name: Decode App Store Connect API key
        if: inputs.dry_run == false
        env:
          ASC_API_KEY: ${{ secrets.ASC_API_KEY }}
        run: |
          echo "$ASC_API_KEY" | base64 -d > /tmp/asc_api_key_pkcs8.p8
          openssl ec -in /tmp/asc_api_key_pkcs8.p8 -out /tmp/asc_api_key.p8 2>/dev/null

      - name: Build and upload to TestFlight
        if: inputs.dry_run == false
        working-directory: ios
        env:
          ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
          ASC_API_KEY_PATH: /tmp/asc_api_key.p8
          ASC_API_KEY_PKCS8_PATH: /tmp/asc_api_key_pkcs8.p8
          MATCH_GIT_URL: https://${{ secrets.GH_PAT }}@github.com/zkproofport/ios-certificates.git
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          BUILD_NUMBER: ${{ github.run_number }}
        run: bundle exec fastlane ios beta env:production

      - name: Build only (dry run)
        if: inputs.dry_run == true
        working-directory: ios
        env:
          APP_ENV: production
        run: |
          xcodebuild -workspace ProofportApp.xcworkspace \
            -scheme ProofportApp \
            -configuration Release \
            -sdk iphoneos \
            -arch arm64 \
            APP_ENV=$APP_ENV \
            CODE_SIGNING_ALLOWED=NO \
            build

      - name: Upload IPA artifact
        if: inputs.dry_run == false
        uses: actions/upload-artifact@v4
        with:
          name: ProofportApp.ipa
          path: ios/build/ProofportApp.ipa

  build-android:
    name: Build Android
    needs: version
    if: |
      needs.version.outputs.new_release_published == 'true' &&
      (inputs.platform == 'both' || inputs.platform == 'android')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}

      - name: Authenticate to Google Cloud
        if: inputs.dry_run == false
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/995938448974/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'github-actions@zkproofport.iam.gserviceaccount.com'

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            android/.gradle
          key: gradle-${{ hashFiles('android/gradle/wrapper/gradle-wrapper.properties', 'android/app/build.gradle', 'android/build.gradle') }}
          restore-keys: gradle-

      - name: Cache node_modules
        id: cache-node-android
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node-${{ hashFiles('package-lock.json') }}

      - name: Decode keystore
        if: inputs.dry_run == false
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > android/app/release.keystore

      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android/sdk/ndk /opt/ghc
          df -h /

      - name: Download mopro binaries
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          gh release download mopro-binaries-v0.3.2 \
            --pattern 'android-jniLibs-arm64-v8a.tar.gz' \
            --dir /tmp
          mkdir -p mopro_bindings/android/src/main/jniLibs
          tar xzf /tmp/android-jniLibs-arm64-v8a.tar.gz -C mopro_bindings/android/src/main/jniLibs/
          rm /tmp/android-jniLibs-arm64-v8a.tar.gz

      - name: Install dependencies
        if: steps.cache-node-android.outputs.cache-hit != 'true'
        run: npm install --legacy-peer-deps

      - name: Build AAB
        if: inputs.dry_run == false
        working-directory: android
        env:
          ANDROID_KEYSTORE_FILE: release.keystore
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          ORG_GRADLE_PROJECT_reactNativeArchitectures: arm64-v8a
        run: bundle exec fastlane android beta flavor:production

      - name: Build APK (dry run)
        if: inputs.dry_run == true
        working-directory: android
        env:
          ORG_GRADLE_PROJECT_reactNativeArchitectures: arm64-v8a
        run: ./gradlew assembleProductionRelease

      - name: Upload AAB artifact
        if: inputs.dry_run == false
        uses: actions/upload-artifact@v4
        with:
          name: app-production-release.aab
          path: android/app/build/outputs/bundle/productionRelease/*.aab

      - name: Upload APK artifact
        if: inputs.dry_run == true
        uses: actions/upload-artifact@v4
        with:
          name: app-production-release.apk
          path: android/app/build/outputs/apk/production/release/*.apk
