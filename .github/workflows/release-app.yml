name: Release App

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Build environment'
        required: true
        default: 'production'
        type: choice
        options:
          - staging
          - production
      dry_run:
        description: 'Dry run (skip upload)'
        type: boolean
        default: true
      platform:
        description: 'Target platform'
        type: choice
        options:
          - both
          - ios
          - android
        default: both

permissions:
  contents: write

jobs:
  version:
    name: Determine Version
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.semantic.outputs.new_release_version }}
      new_release_published: ${{ steps.semantic.outputs.new_release_published }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install semantic-release
        run: npm install --no-save --legacy-peer-deps semantic-release @semantic-release/changelog @semantic-release/git @semantic-release/exec

      - name: Run semantic-release
        id: semantic
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: github-actions[bot]@users.noreply.github.com
          GIT_COMMITTER_NAME: github-actions[bot]
          GIT_COMMITTER_EMAIL: github-actions[bot]@users.noreply.github.com
        run: |
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            npx semantic-release --dry-run 2>&1 | tee sr-output.txt
            VERSION=$(grep -oP 'The next release version is \K[0-9]+\.[0-9]+\.[0-9]+' sr-output.txt || echo "")
            echo "new_release_version=$VERSION" >> "$GITHUB_OUTPUT"
            echo "new_release_published=$( [ -n \"$VERSION\" ] && echo true || echo false )" >> "$GITHUB_OUTPUT"
          else
            npx semantic-release
          fi

      - name: Version summary
        run: |
          echo "## Version" >> "$GITHUB_STEP_SUMMARY"
          echo "- New version: ${{ steps.semantic.outputs.new_release_version }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Published: ${{ steps.semantic.outputs.new_release_published }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Dry run: ${{ inputs.dry_run }}" >> "$GITHUB_STEP_SUMMARY"

  build-ios:
    name: Build iOS
    needs: version
    if: |
      needs.version.outputs.new_release_published == 'true' &&
      (inputs.platform == 'both' || inputs.platform == 'ios')
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true

      - name: Install dependencies
        run: |
          npm install --legacy-peer-deps
          cd ios && rm -f Podfile.lock && pod install --repo-update

      - name: Decode App Store Connect API key
        if: inputs.dry_run == false
        env:
          ASC_API_KEY: ${{ secrets.ASC_API_KEY }}
        run: echo "$ASC_API_KEY" | base64 -d > /tmp/asc_api_key.p8

      - name: Build and upload to TestFlight
        if: inputs.dry_run == false
        working-directory: ios
        env:
          ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
          ASC_API_KEY_PATH: /tmp/asc_api_key.p8
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          BUILD_NUMBER: ${{ github.run_number }}
        run: bundle exec fastlane ios beta env:${{ inputs.environment }}

      - name: Build only (dry run)
        if: inputs.dry_run == true
        working-directory: ios
        env:
          APP_ENV: ${{ inputs.environment == 'staging' && 'development' || 'production' }}
        run: |
          xcodebuild -workspace ProofportApp.xcworkspace \
            -scheme ProofportApp \
            -configuration Release \
            -sdk iphoneos \
            -arch arm64 \
            APP_ENV=$APP_ENV \
            CODE_SIGNING_ALLOWED=NO \
            build

      - name: Upload IPA artifact
        if: inputs.dry_run == false
        uses: actions/upload-artifact@v4
        with:
          name: ProofportApp.ipa
          path: ios/build/ProofportApp.ipa

  build-android:
    name: Build Android
    needs: version
    if: |
      needs.version.outputs.new_release_published == 'true' &&
      (inputs.platform == 'both' || inputs.platform == 'android')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true

      - name: Decode keystore
        if: inputs.dry_run == false
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > android/app/release.keystore

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Build AAB
        if: inputs.dry_run == false
        working-directory: android
        env:
          ANDROID_KEYSTORE_FILE: release.keystore
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: bundle exec fastlane android beta flavor:${{ inputs.environment }}

      - name: Build APK (dry run)
        if: inputs.dry_run == true
        working-directory: android
        run: ./gradlew assemble${{ inputs.environment == 'staging' && 'Staging' || 'Production' }}Release

      - name: Upload AAB artifact
        if: inputs.dry_run == false
        uses: actions/upload-artifact@v4
        with:
          name: app-${{ inputs.environment }}-release.aab
          path: android/app/build/outputs/bundle/${{ inputs.environment }}Release/*.aab

      - name: Upload APK artifact
        if: inputs.dry_run == true
        uses: actions/upload-artifact@v4
        with:
          name: app-${{ inputs.environment }}-release.apk
          path: android/app/build/outputs/apk/${{ inputs.environment }}/release/*.apk
